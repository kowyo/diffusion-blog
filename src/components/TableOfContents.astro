---
interface Props {
  headings: { depth: number; slug: string; text: string }[];
}

const { headings } = Astro.props;
const filtered = headings.filter((h) => h.depth > 1 && h.depth < 4);
---

{
  filtered.length > 0 && (
    <aside class="toc-sidebar" aria-label="Table of contents">
      <nav class="toc">
        <h2 class="toc-title">Table of Contents</h2>
        <ul class="toc-list">
          {filtered.map((h) => (
            <li class={`toc-item depth-${h.depth}`}>
              <a href={`#${h.slug}`}>{h.text}</a>
            </li>
          ))}
        </ul>
      </nav>
    </aside>
  )
}

<style>
  .toc-sidebar {
    display: none;
  }

  @media (min-width: 1200px) {
    .toc-sidebar {
      display: block;
      position: fixed;
      top: 6rem;
      left: calc(50% + var(--width-page) / 2 + 2rem);
      width: 220px;
    }
  }

  @media print {
    .toc-sidebar {
      display: none;
    }
  }

  .toc {
    padding: 0;
    margin: 0;
  }

  .toc-title {
    font-size: 0.75rem;
    font-weight: 700;
    text-transform: uppercase;
    letter-spacing: 0.1em;
    margin: 0 0 1rem 0;
    color: var(--color-text-tertiary);
  }

  .toc-list {
    list-style: none;
    padding: 0;
    margin: 0;
  }

  .toc-item {
    font-size: 0.875rem;
    line-height: 1.4;
    margin-bottom: 0.75rem;
  }

  .toc-item a {
    color: var(--color-text-secondary);
    text-decoration: none;
    transition: color 0.2s ease, border-color 0.2s ease;
    display: block;
    border-left: 2px solid transparent;
    padding-left: 0.75rem;
    margin-left: -0.875rem;
  }

  .toc-item a:hover {
    color: var(--color-text);
  }

  .toc-item.active a {
    color: var(--color-text);
    font-weight: 600;
    border-left-color: var(--color-text);
  }

  .toc-item.depth-3 {
    padding-left: 1rem;
    font-size: 0.8125rem;
  }
</style>

<script>
  const observerOptions = {
    root: null,
    rootMargin: "-100px 0px -66%",
    threshold: 1.0,
  };

  const observer = new IntersectionObserver((entries) => {
    entries.forEach((entry) => {
      const id = entry.target.getAttribute("id");
      if (entry.isIntersecting) {
        document.querySelectorAll(".toc-item").forEach((item) => {
          item.classList.remove("active");
        });
        const activeLink = document.querySelector(`.toc-item a[href="#${id}"]`);
        if (activeLink) {
          activeLink.parentElement?.classList.add("active");
        }
      }
    });
  }, observerOptions);

  document.querySelectorAll(".prose h2, .prose h3").forEach((section) => {
    observer.observe(section);
  });
</script>
